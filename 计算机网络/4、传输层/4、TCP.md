#### TCP协议特点
1. 面向连接
2. 字节流
3. 全双工
4. 支持并发的TCP连接（服务器同时响应多个连接）
5. 可靠（不丢失、不重复、有序）
6. TCP传输的单位时报文段
#### TCP报文格式
![[Pasted image 20240602115436.png]]
1. 发送序号：数据部分的第一个字节的序列
2. 确认序号：接受的数据部分最后一个字节的序列号y+1，表示要求另一方从y+1开始发送。主机A填向报文段的确认好是主机A期望B发送的下一字节的序列号。
3. 报头长度：单位是4字节
4. 窗口：当前进程可接受的数据长度，是发送方确认发送窗口的依据，也叫接受窗口、通知窗口，用于流量控制
5. 校验和：计算方式和UDP相同，需要伪首部
	1. TCP必选
6. 报头长度为20字节到60字节
7. MSS：最大报文段长度，指的是报文段中数据部分长度
8. TCP一个报文段的序号是该报文段的首字节的字节流序号
#### TCP连接建立
![[Pasted image 20240610232242.png]]
1. SYN和ACK
2. seq和ACK
#### TCP连接释放
![[Pasted image 20240610232613.png]]

#### TCP数据传输过程
服务端：保持定时器
客户端：时间等待定时器
#### TCP滑动窗口和确认重传
![[Pasted image 20240602120603.png]]
1. 接收方数据报的分类
	1. 发送且确认
	2. 发送未确认
	3. 准备好未发送
	4. 无准备未发送
2. 发送窗口的长度=准备好未发送部分+已发送未确认部分
3. 滑动：当窗口内含有发送且确认的数据，窗口就会向左滑动，直到不包含发送且确认的数据
![[Pasted image 20240602121151.png]]
4. 发送方的数据报分类
	1. 接受到的并上交给上一层的
	2. 未接收到的
	3. 接收到的未上交给上一层的
		1. 接收方每回复了一个ACK就会上交一个分组
		2. 接受窗口的rsv_base指针前面永远是已经上交的
![[Pasted image 20240602211818.png]]
如果接收到一个base指针指向的分组，就会将base分组和后面的接收到的连续的部分上交，窗口移动，不连续的部分仍然会在窗口中
###### 回退n（Go-Back-N，GBN）
假设A向B发了5个报文段、第二个报文段B没有收到、不管3、4、5B有没有收到、A要向B发送2以后的所有报文段
###### 选择重发（SACK）
发送方只需要发送丢失部分
#### TCP滑动窗口和超时重传
重传定时器
#### TCP窗口和流量控制
1. 零窗口通告：发送速度大于从缓存中读取的速度，导致缓存溢出、接受方要想发送方发送纯ACK报文段（数据长度=0，窗口字段=0）
2. 窗口更新：当接收方缓存从满状态变为有可用空间，要向发送方发送纯ACK报文段（数据长度=0，窗口字段>0）
3. 窗口探测：因为纯ACK报文不能被TCP可靠传递，所以发送方会设置 坚持定时器来定期发送窗口探测报文段，保证被TCP传递，接收方将缓冲区可用空间大小放入ACK报文窗口字段中，保证可靠传输，利用TCP可靠传输机制 
#### TCP窗口和拥塞控制
TCP的发送窗口大小为$min(接收方通知窗口（rwnd）、发送方拥塞窗口（cwnd）)$
1. 通知窗口：接收方允许接受的能力
2. 拥塞窗口：发送方根据网络拥塞情况得到的窗口值
拥塞判定：
1. 发送方重传定时器超时
2. 发送方收到三个相同的ACK报文
拥塞控制：
![[Pasted image 20240602142254.png]]
1. 慢开始
	1. 慢开始阈值SST：慢开始阶段和拥塞避免阶段的分界线
	2. 慢开始阶段：初始为1，每结束一个RTT，cwnd翻倍，绝对不能超过阈值
2.  拥塞避免阶段：线性增加
3. 当发生拥塞时：
	1. 拥塞避免阶段结束
	2. 设置STT=cwnd/2
	3. 在Tahoe版本设置cwnd=1，重新开始。在Reno版本设置cwnd=cwnd/2，直接进入拥塞避免阶段
4. 快重传
	1. 接受方向发送方发送连续3次相同的ACK报文
	2. 发送方收到连续三次相同ACK报文


